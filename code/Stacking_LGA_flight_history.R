###########################################################################################-
###########################################################################################-
##
## Animating LGA flight history ----
##
###########################################################################################-
###########################################################################################-

#=========================================================================================#
# Setting up ----
#=========================================================================================#

#-----------------------------------------------------------------------------------------#
# Loading libraries
#-----------------------------------------------------------------------------------------#

library(tidyverse)
library(lubridate)
library(glue)
library(fs)

#-----------------------------------------------------------------------------------------#
# Which dates are we combining?
#-----------------------------------------------------------------------------------------#

video_date_1 <- "2020-03-16" %>% as_date()
video_date_2 <- "2020-04-06" %>% as_date()

#-----------------------------------------------------------------------------------------#
# Getting video paths
#-----------------------------------------------------------------------------------------#

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Paths
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

plots_files <- dir_ls("plots/videos")

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Choosing among potential options
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

#==== Video 1 ====# 

video_1_choices <- 
	plots_files %>% 
	str_subset(as.character(video_date_1))


if (length(video_1_choices) > 1) {
	
	video_1 <- 
		menu(
			choices = video_1_choices, 
			graphics = TRUE,
			title = "Which video do you want to use for video_1?"
		) %>% 
		pluck(video_1_choices, .)
	
} else {
	
	video_1 <- video_1_choices
	
}


#==== Video 2 ====# 

video_2_choices <- 
	plots_files %>% 
	str_subset(as.character(video_date_2))


if (length(video_2_choices) > 1) {
	
	video_2 <- 
		menu(
			choices = video_2_choices, 
			graphics = TRUE,
			title = "Which video do you want to use for video_2?"
		) %>% 
		pluck(video_2_choices, .)
	
} else {
	
	video_2 <- video_2_choices
	
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# Root of the video name
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

video_name_root <- 
	video_1 %>% 
	path_file() %>% 
	path_ext_remove() %>% 
	str_remove(as.character(video_date_1))


#=========================================================================================#
# Stacking ----
#=========================================================================================#

system(
	glue(
		"ffmpeg -hide_banner -y",
		"-i {video_1}",
		"-i {video_2}",
		"-filter_complex hstack=inputs=2",
		"-c:v libx265",
		"-x265-params range=full:qp=20",
		"-pix_fmt yuvj420p",
		"plots/videos/{video_name_root}-_{video_date_1}_vs._{video_date_2}.mp4",
		.sep = " "
	)
)


# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# #
# #                             ---- THIS IS THE END! ----
# #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
